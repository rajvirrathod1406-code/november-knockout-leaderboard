<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>November Knockout — Dashboard</title>
<style>
  :root{
    --gold:#e4b229; --deep:#0a2142; --mid:#0e3769; --ink:#0b1b32;
    --card:rgba(255,255,255,.06); --stroke:rgba(255,255,255,.18);
  }

  html, body{
    height:100%; margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#fff;
    background:
      repeating-linear-gradient(-45deg, rgba(255,255,255,.05) 0px, rgba(255,255,255,.05) 2px, transparent 2px, transparent 12px),
      linear-gradient(180deg, var(--mid) 0%, var(--deep) 100%) !important;
    background-attachment:fixed, fixed !important;
  }
  .bg{position:fixed; inset:0; z-index:-1;
    background:
      repeating-linear-gradient(-45deg, rgba(255,255,255,.05) 0px, rgba(255,255,255,.05) 2px, transparent 2px, transparent 12px),
      linear-gradient(180deg, var(--mid) 0%, var(--deep) 100%);
  }

  .wrap{max-width:1300px;margin:0 auto; padding:28px}
  .title{font-size:48px;font-weight:900;letter-spacing:.06em;text-transform:uppercase;color:var(--gold);text-align:center;margin:0 0 6px}
  .subtitle{opacity:.9;text-align:center;margin:0 0 18px}

  .tabs{display:flex;gap:8px;justify-content:center;margin-bottom:16px;flex-wrap:wrap}
  .tab{background:var(--card); border:1px solid var(--stroke); color:#eaf2ff;
    padding:10px 14px; border-radius:999px; cursor:pointer; user-select:none}
  .tab[aria-selected="true"]{ background:#163a6b; border-color:#1f4f91; font-weight:800 }

  .panel{ display:none } .panel.active{ display:block }

  .chartCard{ background:var(--card); border:1px solid var(--stroke);
    border-radius:16px; padding:16px; margin-bottom:22px; backdrop-filter:saturate(120%) blur(4px);
    height:min(70vh,720px) }
  .chartCard canvas{ width:100% !important; height:calc(100% - 64px) !important; display:block }

  .legendBar{
    display:flex; gap:14px; align-items:center; justify-content:center;
    margin:2px 0 10px; flex-wrap:wrap
  }
  .legendItem{display:flex; align-items:center; gap:8px; padding:6px 10px; background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.18); border-radius:999px; font-weight:700; font-size:13px}
  .legendSwatch{width:18px;height:4px;border-radius:2px}
  .legendImg{width:22px;height:22px;object-fit:contain;border-radius:4px;background:#fff;padding:2px;box-shadow:0 0 0 1px rgba(0,0,0,.08) inset}
  .legendText{line-height:1}

  .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap:22px; align-items:start }
  .box{ background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:0; backdrop-filter:saturate(120%) blur(4px) }
  .box header{ padding:12px 16px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,.12); background:#0e325e; border-top-left-radius:16px; border-top-right-radius:16px }
  .date{font-weight:900;font-size:18px}
  .summary{color:#e7edf7;font-size:12px;opacity:.9}
  table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border-radius:0 0 16px 16px;overflow:hidden}
  tbody td{padding:14px 16px;vertical-align:middle;border-top:1px solid #eef2f7}
  tbody tr:first-child td{border-top:none}
  tbody tr:nth-child(even){background:#f8fbff}
  .team{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px;color:var(--ink)}
  .team img{width:36px;height:36px;object-fit:contain;border-radius:8px;background:#f6f8fb;padding:4px;box-shadow:inset 0 0 0 2px #fff, 0 0 0 1px #e7edf5}
  .pct{font-weight:900;text-align:right;color:var(--ink);white-space:nowrap}
  .after-divider td{border-top:4px solid var(--gold)!important}

  .footer-note{color:#d4d8e0;font-size:14px;opacity:.9;text-align:center;margin:18px auto 0;max-width:800px}

  /* --------- Mobile tweaks --------- */
  @media (max-width: 640px){
    .wrap{padding:16px}
    .title{font-size:28px; margin-bottom:2px}
    .subtitle{font-size:13px}
    /* Legend compresses & becomes a horizontal scroller */
    .legendBar{
      justify-content:flex-start;
      gap:8px;
      overflow-x:auto;
      white-space:nowrap;
      scrollbar-width:thin;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px;
      margin:0 0 8px;
    }
    .legendItem{font-size:11px; padding:4px 6px}
    .legendImg{width:16px;height:16px}
    .legendSwatch{width:12px;height:3px}
    /* Chart is taller; less top/bottom padding */
    .chartCard{height:78vh; padding:12px}
    .chartCard canvas{height:calc(100% - 52px) !important}
    .grid{grid-template-columns:1fr}
    .team{font-size:16px}
  }
</style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>

  <div class="wrap">
    <div class="title">November Knockout 2025</div>

    <div class="tabs" role="tablist" aria-label="Dashboard sections">
      <button class="tab" role="tab" id="tab-overview" aria-controls="panel-overview" aria-selected="true">Overview</button>
      <button class="tab" role="tab" id="tab-results" aria-controls="panel-results" aria-selected="false">Results</button>
    </div>

    <section id="panel-overview" class="panel active" role="tabpanel" aria-labelledby="tab-overview">
      <div class="chartCard">
        <div id="customLegend" class="legendBar" aria-label="Legend"></div>
        <canvas id="progressChart"></canvas>
      </div>
    </section>

    <section id="panel-results" class="panel" role="tabpanel" aria-labelledby="tab-results">
      <div id="grid" class="grid"></div>
    </section>

    <div class="footer-note">
      Note: The figures are sourced from the coordinator's MIS; final results will be reconciled.
    </div>
  </div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/* ---- Logos & colors ---- */
const LOGO={
  'Capital Chargers':'https://i.postimg.cc/d0mhp9Lt/Capital-Chargers-Logo-with-Mosque-Emblem-1.png',
  'Desert Warriors':'https://i.postimg.cc/rzXcqvPG/Desert-Warriors.png',
  'ENBD Eagles':'https://i.postimg.cc/gJxnjbgL/ENBD-Eagles-Logo-Design.png',
  'Twin Force':'https://i.postimg.cc/2ST6xStP/Twin-Force.png'
};
const COLORS={
  'Capital Chargers':'#4FC3F7',
  'Desert Warriors':'#FF6F91',
  'ENBD Eagles':'#FFD166',
  'Twin Force':'#7CF07C'
};
const REF_TARGET='#7fd3de', REF_TIME='#b28bff';

/* ---- Data (edit daily) ---- */
const data = {
  3:{'Capital Chargers':2.3,'Desert Warriors':0.7,'ENBD Eagles':1.5,'Twin Force':4.9},
  4:{'Capital Chargers':3.2,'Desert Warriors':4.1,'ENBD Eagles':4.4,'Twin Force':7.2},
  5:{'Capital Chargers':7.7,'Desert Warriors':7.5,'ENBD Eagles':4.7,'Twin Force':10.5},
  6:{'Capital Chargers':0,'Desert Warriors':0,'ENBD Eagles':0,'Twin Force':0}
};

const fmt = n => (Math.round(n*10)/10).toFixed(1) + '%';
const isSmall = window.matchMedia('(max-width: 640px)').matches;

/* ---- Legend ---- */
function buildLegend(container, teamOrder, refs){
  container.innerHTML='';
  teamOrder.forEach(team=>{
    container.innerHTML += `
      <div class="legendItem">
        <img class="legendImg" src="${LOGO[team]}" alt="${team} logo" />
        <span class="legendText">${team}</span>
        <span class="legendSwatch" style="background:${COLORS[team]}"></span>
      </div>`;
  });
  refs.forEach(({label,color})=>{
    container.innerHTML += `
      <div class="legendItem">
        <span class="legendText">${label}</span>
        <span class="legendSwatch" style="background:${color}"></span>
      </div>`;
  });
}

/* ---- Plugin: team end labels + single Daily Target label ---- */
const endLabelPlugin = {
  id: 'endLabelPlugin',
  afterDatasetsDraw(chart){
    const {ctx, chartArea} = chart;
    ctx.save();
    ctx.font = (isSmall ? '700 10px' : '700 12px') + ' Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';

    const nudge = { 'Capital Chargers':-8, 'Desert Warriors':8, 'ENBD Eagles':-2, 'Twin Force':2 };

    chart.data.datasets.forEach(ds => {
      if (ds.yAxisID !== 'yData') return;
      const meta = chart.getDatasetMeta(chart.data.datasets.indexOf(ds));
      for (let j = ds.data.length - 1; j >= 0; j--) {
        const val = ds.data[j];
        if (val == null) continue;
        const pt = meta.data[j];
        if (!pt) continue;

        const label = fmt(val);
        let x = pt.x + (isSmall ? 6 : 8);
        let y = pt.y + (nudge[ds.label] ?? 0);

        const w = ctx.measureText(label).width;
        if (x + w > chartArea.right - 6) x = chartArea.right - 6 - w;
        if (y < chartArea.top + 6) y = chartArea.top + 6;
        if (y > chartArea.bottom - 6) y = chartArea.bottom - 6;

        ctx.lineWidth = 3.5;
        ctx.strokeStyle = 'rgba(10,33,66,0.92)';
        ctx.strokeText(label, x, y);
        ctx.fillStyle = ds.borderColor || '#fff';
        ctx.fillText(label, x, y);
        break;
      }
    });
    ctx.restore();
  },
  afterDraw(chart){
    const {ctx, chartArea, scales} = chart;
    const daily = chart.data.datasets.find(d => d.label.startsWith('Daily Target'));
    if (!daily) return;

    const yVal = daily.data[0];
    const y = scales.yData.getPixelForValue(yVal);
    const text = (Math.round(yVal*100)/100).toFixed(2) + '%';

    ctx.save();
    ctx.font = (isSmall ? '700 10px' : '700 12px') + ' Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';

    let x = chartArea.right - 8;
    let yDraw = Math.min(chartArea.bottom - 8, Math.max(chartArea.top + 8, y - 6));

    ctx.lineWidth = 3.5;
    ctx.strokeStyle = 'rgba(10,33,66,0.92)';
    ctx.strokeText(text, x, yDraw);
    ctx.fillStyle = REF_TIME;
    ctx.fillText(text, x, yDraw);
    ctx.restore();
  }
};

/* ---- Chart ---- */
(function renderChart(){
  const teams = ['Capital Chargers','Desert Warriors','ENBD Eagles','Twin Force'];
  const days   = Array.from({length:30}, (_,i)=>i+1);
  const labels = days.map(d => `Nov ${d}`);

  const datasets = teams.map(team => ({
    label: team,
    data: days.map(d => {
      const v = (data[d] && typeof data[d][team] === 'number') ? data[d][team] : null;
      return v === 0 ? null : v;
    }),
    borderColor: COLORS[team],
    pointBackgroundColor: COLORS[team],
    pointBorderColor: COLORS[team],
    backgroundColor: COLORS[team],
    borderWidth: isSmall ? 2.2 : 3.5,
    tension:.25,
    pointRadius: isSmall ? 2.2 : 3.5,
    spanGaps:false,
    yAxisID:'yData'
  }));

  // Daily Target (% of month elapsed)
  const now = new Date();
  const isNov2025 = (now.getFullYear()===2025 && now.getMonth()===10);
  const todayDay = Math.min(30, Math.max(1, isNov2025 ? now.getDate() : 1));
  const dailyTargetPct = +(todayDay / 30 * 100).toFixed(2);

  const maxTeam = Math.max(...datasets.flatMap(ds => ds.data.filter(v => v != null)), 0);
  const yMax = (maxTeam <= dailyTargetPct) ? dailyTargetPct : Math.min(100, Math.ceil((maxTeam + 0.5) * 10) / 10);

  // Reference lines
  datasets.push(
    { label:'Target (100%)', data: days.map(() => 100), borderColor: REF_TARGET,
      borderWidth: 2, borderDash: [6,6], pointRadius: 0, yAxisID: 'yRef' },
    { label:`Daily Target (${dailyTargetPct}%)`, data: days.map(() => dailyTargetPct),
      borderColor: REF_TIME, borderWidth: 2, borderDash: [2,4], pointRadius: 0, yAxisID: 'yData' }
  );

  const ctx = document.getElementById('progressChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    plugins: [endLabelPlugin],
    options: {
      responsive: true, maintainAspectRatio: false,
      layout: { padding: { left: 8, right: 12, top: 0, bottom: 6 } },
      scales: {
        yData: {
          position: 'left', min: 0, max: yMax,
          grid: { color: 'rgba(255,255,255,0.12)' },
          ticks: {
            callback: v => v + '%',
            font: { size: isSmall ? 10 : 12 },
            maxTicksLimit: isSmall ? 6 : 10
          },
          title: { display: !isSmall, text: '% Achievement (Teams)' }
        },
        yRef: {
          position: 'right', min: 0, max: 100,
          grid: { display: false },
          ticks: { callback: v => v + '%', font: { size: isSmall ? 10 : 12 } },
          title: { display: !isSmall, text: 'Reference (0–100%)' },
          display: !isSmall
        },
        x: {
          grid: { color: 'rgba(255,255,255,0.06)' },
          ticks: {
            autoSkip: true,
            maxTicksLimit: isSmall ? 6 : 15,
            maxRotation: 0, minRotation: 0,
            font: { size: isSmall ? 10 : 12 }
          },
          title: { display: true, text: 'Date' }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          filter: c => c.raw !== null && c.raw !== undefined,
          bodyFont: { size: isSmall ? 11 : 12 },
          callbacks: { label: c => `${c.dataset.label}: ${fmt(c.parsed.y||0)}` }
        }
      },
      elements: { line: { fill: false } }
    }
  });

  buildLegend(
    document.getElementById('customLegend'),
    teams,
    [
      {label:'Target (100%)', color: REF_TARGET},
      {label:`Daily Target (${dailyTargetPct}%)`, color: REF_TIME}
    ]
  );
})();

/* ---- Results (date cards) ---- */
(function renderCards(){
  const grid = document.getElementById('grid');
  const visibleDays = Object.keys(data).map(Number).sort((a,b)=>a-b)
    .filter(d => Object.values(data[d]||{}).some(v => v > 0));

  function sortEntries(obj){
    return Object.entries(obj||{}).map(([team,percent])=>({team,percent:+percent||0}))
      .sort((a,b)=> b.percent - a.percent || a.team.localeCompare(b.team));
  }
  function dividerAfterIndex(rows){
    if(!rows.length) return 0;
    const cut = Math.min(1, rows.length-1);
    let idx = cut; for(let i=cut+1;i<rows.length;i++){ if(rows[i].percent===rows[cut].percent) idx=i; else break; }
    return idx+1;
  }
  const fmtPct = v => (Math.round(v*10)/10).toFixed(1)+'%';

  visibleDays.forEach(d=>{
    const rows = sortEntries(data[d]);
    const cutAt = dividerAfterIndex(rows);
    const top = rows[0] || {team:'', percent:0};

    const html = `
      <div class="box">
        <header>
          <div class="date">Nov ${d}</div>
          <div class="summary">${top.team ? `${top.team}: ${fmtPct(top.percent)}` : '&nbsp;'}</div>
        </header>
        <table aria-label="Leaderboard for Nov ${d}">
          <tbody>
            ${rows.map((r,i)=>`
              <tr ${i===cutAt && i<rows.length ? 'class="after-divider"' : ''}>
                <td><div class="team"><img src="${LOGO[r.team]}" alt="${r.team} logo">${r.team}</div></td>
                <td class="pct">${fmtPct(r.percent)}</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>`;
    grid.insertAdjacentHTML('beforeend', html);
  });
})();

/* ---- Tabs ---- */
const tabs=document.querySelectorAll('.tab');const panels=document.querySelectorAll('.panel');
tabs.forEach(tab=>{
  tab.addEventListener('click',()=>{
    tabs.forEach(t=>t.setAttribute('aria-selected','false'));
    panels.forEach(p=>p.classList.remove('active'));
    tab.setAttribute('aria-selected','true');
    document.getElementById(tab.getAttribute('aria-controls')).classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  });
});
</script>
</body>
</html>
